{"ast":null,"code":"import _objectWithoutProperties from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _objectSpread from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";var _excluded=[\"event\"];var _EVENT$MESSAGE;import EventEmitter from'eventemitter3';import{iceServers}from'../../utils';import{OPCODE}from'./data';import{EVENT}from'./events';_EVENT$MESSAGE=EVENT.MESSAGE;export var BaseClient=/*#__PURE__*/function(_EventEmitter,_EVENT$MESSAGE2){_inherits(BaseClient,_EventEmitter);var _super=_createSuper(BaseClient);function BaseClient(){var _this;_classCallCheck(this,BaseClient);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this._ws=void 0;_this._peer=void 0;_this._channel=void 0;_this._timeout=void 0;_this._displayname=void 0;_this._state='disconnected';_this._id='';return _this;}_createClass(BaseClient,[{key:\"id\",get:function get(){return this._id;}},{key:\"supported\",get:function get(){return typeof RTCPeerConnection!=='undefined'&&typeof RTCPeerConnection.prototype.addTransceiver!=='undefined';}},{key:\"socketOpen\",get:function get(){return typeof this._ws!=='undefined'&&this._ws.readyState===WebSocket.OPEN;}},{key:\"peerConnected\",get:function get(){return typeof this._peer!=='undefined'&&['connected','checking','completed'].includes(this._state);}},{key:\"connected\",get:function get(){return this.peerConnected&&this.socketOpen;}},{key:\"connect\",value:function connect(url,password,displayname){var _this2=this;if(this.socketOpen){this.emit('warn',\"attempting to create websocket while connection open\");return;}if(!this.supported){this.onDisconnected(new Error('browser does not support webrtc (RTCPeerConnection missing)'));return;}if(displayname===''){throw new Error('Must add a displayname');}this._displayname=displayname;this[EVENT.CONNECTING]();try{this._ws=new WebSocket(\"\".concat(url,\"ws?password=\").concat(password));this.emit('debug',\"connecting to \".concat(this._ws.url));this._ws.onmessage=this.onMessage.bind(this);this._ws.onerror=function(event){return _this2.onError.bind(_this2);};this._ws.onclose=function(event){return _this2.onDisconnected.bind(_this2,new Error('websocket closed'));};this._timeout=setTimeout(this.onTimeout.bind(this),15000);}catch(err){this.onDisconnected(err);}}},{key:\"disconnect\",value:function disconnect(){if(this._timeout){clearTimeout(this._timeout);}if(this.socketOpen){try{this._ws.close();}catch(err){}this._ws=undefined;}if(this.peerConnected){try{this._peer.close();}catch(err){}this._peer=undefined;}this._state='disconnected';this._displayname=undefined;this._id='';}},{key:\"sendData\",value:function sendData(event,data){if(!this.connected){this.emit('warn',\"attempting to send data while disconnected\");return;}var buffer;var payload;switch(event){case'mousemove':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.MOVE);payload.setUint16(1,4,true);payload.setUint16(3,data.x,true);payload.setUint16(5,data.y,true);break;case'wheel':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.SCROLL);payload.setUint16(1,4,true);payload.setInt16(3,data.x,true);payload.setInt16(5,data.y,true);break;case'keydown':case'mousedown':buffer=new ArrayBuffer(5);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_DOWN);payload.setUint16(1,1,true);payload.setUint16(3,data.key,true);break;case'keyup':case'mouseup':buffer=new ArrayBuffer(5);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_UP);payload.setUint16(1,1,true);payload.setUint16(3,data.key,true);break;default:this.emit('warn',\"unknown data event: \".concat(event));}// @ts-ignore\nif(typeof buffer!=='undefined'){this._channel.send(buffer);}}},{key:\"sendMessage\",value:function sendMessage(event,payload){if(!this.connected){this.emit('warn',\"attempting to send message while disconnected\");return;}this.emit('debug',\"sending event '\".concat(event,\"' \").concat(payload?\"with payload: \":''),payload);this._ws.send(JSON.stringify(_objectSpread({event:event},payload)));}},{key:\"createPeer\",value:function createPeer(sdp,lite,servers){var _this3=this;this.emit('debug',\"creating peer\");if(!this.socketOpen){this.emit('warn',\"attempting to create peer with no websocket: \",this._ws?\"state: \".concat(this._ws.readyState):'no socket');return;}if(this.peerConnected){this.emit('warn',\"attempting to create peer while connected\");return;}this._peer=new RTCPeerConnection();if(lite!==true){this._peer=new RTCPeerConnection({iceServers:servers?[{urls:servers}]:iceServers()});}this._peer.onconnectionstatechange=function(event){_this3.emit('debug',\"peer connection state changed\",_this3._peer?_this3._peer.connectionState:undefined);};this._peer.onsignalingstatechange=function(event){_this3.emit('debug',\"peer signaling state changed\",_this3._peer?_this3._peer.signalingState:undefined);};this._peer.oniceconnectionstatechange=function(event){_this3._state=_this3._peer.iceConnectionState;_this3.emit('debug',\"peer ice connection state changed: \".concat(_this3._peer.iceConnectionState));switch(_this3._state){case'checking':if(_this3._timeout){clearTimeout(_this3._timeout);}break;case'connected':_this3.onConnected();break;case'failed':_this3.onDisconnected(new Error('peer failed'));break;case'disconnected':_this3.onDisconnected(new Error('peer disconnected'));break;}};this._peer.ontrack=this.onTrack.bind(this);this._peer.addTransceiver('audio',{direction:'recvonly'});this._peer.addTransceiver('video',{direction:'recvonly'});this._channel=this._peer.createDataChannel('data');this._channel.onerror=this.onError.bind(this);this._channel.onmessage=this.onData.bind(this);this._channel.onclose=this.onDisconnected.bind(this,new Error('peer data channel closed'));this._peer.setRemoteDescription({type:'offer',sdp:sdp});this._peer.createAnswer().then(function(d){_this3._peer.setLocalDescription(d);_this3._ws.send(JSON.stringify({event:EVENT.SIGNAL.ANSWER,sdp:d.sdp,displayname:_this3._displayname}));}).catch(function(err){return _this3.emit('error',err);});}},{key:\"onMessage\",value:function onMessage(e){var _ref=JSON.parse(e.data),event=_ref.event,payload=_objectWithoutProperties(_ref,_excluded);this.emit('debug',\"received websocket event \".concat(event,\" \").concat(payload?\"with payload: \":''),payload);if(event===EVENT.SIGNAL.PROVIDE){var _ref2=payload,sdp=_ref2.sdp,lite=_ref2.lite,ice=_ref2.ice,id=_ref2.id;this._id=id;this.createPeer(sdp,lite,ice);return;}// @ts-ignore\nif(typeof this[event]==='function'){// @ts-ignore\nthis[event](payload);}else{this[EVENT.MESSAGE](event,payload);}}},{key:\"onData\",value:function onData(e){this[EVENT.DATA](e.data);}},{key:\"onTrack\",value:function onTrack(event){this.emit('debug',\"received \".concat(event.track.kind,\" track from peer: \").concat(event.track.id),event);var stream=event.streams[0];if(!stream){this.emit('warn',\"no stream provided for track \".concat(event.track.id,\"(\").concat(event.track.label,\")\"));return;}this[EVENT.TRACK](event);}},{key:\"onError\",value:function onError(event){this.emit('error',event.error);}},{key:\"onConnected\",value:function onConnected(){if(this._timeout){clearTimeout(this._timeout);}if(!this.connected){this.emit('warn',\"onConnected called while being disconnected\");return;}this.emit('debug',\"connected\");this[EVENT.CONNECTED]();}},{key:\"onTimeout\",value:function onTimeout(){this.emit('debug',\"connection timeout\");if(this._timeout){clearTimeout(this._timeout);}this.onDisconnected(new Error('connection timeout'));}},{key:\"onDisconnected\",value:function onDisconnected(reason){this.disconnect();this.emit('debug',\"disconnected:\",reason);this[EVENT.DISCONNECTED](reason);}},{key:_EVENT$MESSAGE2,value:function value(event,payload){this.emit('warn',\"unhandled websocket event '\".concat(event,\"':\"),payload);}}]);return BaseClient;}(EventEmitter,_EVENT$MESSAGE);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/VBrowser/base.ts"],"names":["EventEmitter","iceServers","OPCODE","EVENT","MESSAGE","BaseClient","_ws","_peer","_channel","_timeout","_displayname","_state","_id","RTCPeerConnection","prototype","addTransceiver","readyState","WebSocket","OPEN","includes","peerConnected","socketOpen","url","password","displayname","emit","supported","onDisconnected","Error","CONNECTING","onmessage","onMessage","bind","onerror","event","onError","onclose","setTimeout","onTimeout","err","clearTimeout","close","undefined","data","connected","buffer","payload","ArrayBuffer","DataView","setUint8","MOVE","setUint16","x","y","SCROLL","setInt16","KEY_DOWN","key","KEY_UP","send","JSON","stringify","sdp","lite","servers","urls","onconnectionstatechange","connectionState","onsignalingstatechange","signalingState","oniceconnectionstatechange","iceConnectionState","onConnected","ontrack","onTrack","direction","createDataChannel","onData","setRemoteDescription","type","createAnswer","then","d","setLocalDescription","SIGNAL","ANSWER","catch","e","parse","PROVIDE","ice","id","createPeer","DATA","track","kind","stream","streams","label","TRACK","error","CONNECTED","reason","disconnect","DISCONNECTED"],"mappings":"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","sourcesContent":["import EventEmitter from 'eventemitter3';\n\nimport { iceServers } from '../../utils';\nimport { OPCODE } from './data';\nimport { EVENT, WebSocketEvents } from './events';\nimport {\n  SignalProvidePayload,\n  WebSocketMessages,\n  WebSocketPayloads,\n} from './messages';\n\nexport abstract class BaseClient extends EventEmitter<any> {\n  protected _ws?: WebSocket;\n  protected _peer?: RTCPeerConnection;\n  protected _channel?: RTCDataChannel;\n  protected _timeout?: NodeJS.Timeout;\n  protected _displayname?: string;\n  protected _state: RTCIceConnectionState = 'disconnected';\n  protected _id = '';\n\n  get id() {\n    return this._id;\n  }\n\n  get supported() {\n    return (\n      typeof RTCPeerConnection !== 'undefined' &&\n      typeof RTCPeerConnection.prototype.addTransceiver !== 'undefined'\n    );\n  }\n\n  get socketOpen() {\n    return (\n      typeof this._ws !== 'undefined' && this._ws.readyState === WebSocket.OPEN\n    );\n  }\n\n  get peerConnected() {\n    return (\n      typeof this._peer !== 'undefined' &&\n      ['connected', 'checking', 'completed'].includes(this._state)\n    );\n  }\n\n  get connected() {\n    return this.peerConnected && this.socketOpen;\n  }\n\n  public connect(url: string, password: string, displayname: string) {\n    if (this.socketOpen) {\n      this.emit('warn', `attempting to create websocket while connection open`);\n      return;\n    }\n\n    if (!this.supported) {\n      this.onDisconnected(\n        new Error('browser does not support webrtc (RTCPeerConnection missing)')\n      );\n      return;\n    }\n\n    if (displayname === '') {\n      throw new Error('Must add a displayname');\n    }\n\n    this._displayname = displayname;\n    this[EVENT.CONNECTING]();\n\n    try {\n      this._ws = new WebSocket(`${url}ws?password=${password}`);\n      this.emit('debug', `connecting to ${this._ws.url}`);\n      this._ws.onmessage = this.onMessage.bind(this);\n      this._ws.onerror = (event) => this.onError.bind(this);\n      this._ws.onclose = (event) =>\n        this.onDisconnected.bind(this, new Error('websocket closed'));\n      this._timeout = setTimeout(this.onTimeout.bind(this), 15000);\n    } catch (err: any) {\n      this.onDisconnected(err);\n    }\n  }\n\n  protected disconnect() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n\n    if (this.socketOpen) {\n      try {\n        this._ws!.close();\n      } catch (err) {}\n      this._ws = undefined;\n    }\n\n    if (this.peerConnected) {\n      try {\n        this._peer!.close();\n      } catch (err) {}\n      this._peer = undefined;\n    }\n\n    this._state = 'disconnected';\n    this._displayname = undefined;\n    this._id = '';\n  }\n\n  public sendData(\n    event: 'wheel' | 'mousemove',\n    data: { x: number; y: number }\n  ): void;\n  public sendData(\n    event: 'mousedown' | 'mouseup' | 'keydown' | 'keyup',\n    data: { key: number }\n  ): void;\n  public sendData(event: string, data: any) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send data while disconnected`);\n      return;\n    }\n\n    let buffer: ArrayBuffer;\n    let payload: DataView;\n    switch (event) {\n      case 'mousemove':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.MOVE);\n        payload.setUint16(1, 4, true);\n        payload.setUint16(3, data.x, true);\n        payload.setUint16(5, data.y, true);\n        break;\n      case 'wheel':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.SCROLL);\n        payload.setUint16(1, 4, true);\n        payload.setInt16(3, data.x, true);\n        payload.setInt16(5, data.y, true);\n        break;\n      case 'keydown':\n      case 'mousedown':\n        buffer = new ArrayBuffer(5);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_DOWN);\n        payload.setUint16(1, 1, true);\n        payload.setUint16(3, data.key, true);\n        break;\n      case 'keyup':\n      case 'mouseup':\n        buffer = new ArrayBuffer(5);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_UP);\n        payload.setUint16(1, 1, true);\n        payload.setUint16(3, data.key, true);\n        break;\n      default:\n        this.emit('warn', `unknown data event: ${event}`);\n    }\n\n    // @ts-ignore\n    if (typeof buffer !== 'undefined') {\n      this._channel!.send(buffer);\n    }\n  }\n\n  public sendMessage(event: WebSocketEvents, payload?: WebSocketPayloads) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send message while disconnected`);\n      return;\n    }\n    this.emit(\n      'debug',\n      `sending event '${event}' ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n    this._ws!.send(JSON.stringify({ event, ...payload }));\n  }\n\n  public createPeer(sdp: string, lite: boolean, servers: string[]) {\n    this.emit('debug', `creating peer`);\n    if (!this.socketOpen) {\n      this.emit(\n        'warn',\n        `attempting to create peer with no websocket: `,\n        this._ws ? `state: ${this._ws.readyState}` : 'no socket'\n      );\n      return;\n    }\n\n    if (this.peerConnected) {\n      this.emit('warn', `attempting to create peer while connected`);\n      return;\n    }\n\n    this._peer = new RTCPeerConnection();\n    if (lite !== true) {\n      this._peer = new RTCPeerConnection({\n        iceServers: servers ? [{ urls: servers }] : iceServers(),\n      });\n    }\n\n    this._peer.onconnectionstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer connection state changed`,\n        this._peer ? this._peer.connectionState : undefined\n      );\n    };\n\n    this._peer.onsignalingstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer signaling state changed`,\n        this._peer ? this._peer.signalingState : undefined\n      );\n    };\n\n    this._peer.oniceconnectionstatechange = (event) => {\n      this._state = this._peer!.iceConnectionState;\n\n      this.emit(\n        'debug',\n        `peer ice connection state changed: ${this._peer!.iceConnectionState}`\n      );\n\n      switch (this._state) {\n        case 'checking':\n          if (this._timeout) {\n            clearTimeout(this._timeout);\n          }\n          break;\n        case 'connected':\n          this.onConnected();\n          break;\n        case 'failed':\n          this.onDisconnected(new Error('peer failed'));\n          break;\n        case 'disconnected':\n          this.onDisconnected(new Error('peer disconnected'));\n          break;\n      }\n    };\n\n    this._peer.ontrack = this.onTrack.bind(this);\n    this._peer.addTransceiver('audio', { direction: 'recvonly' });\n    this._peer.addTransceiver('video', { direction: 'recvonly' });\n\n    this._channel = this._peer.createDataChannel('data');\n    this._channel.onerror = this.onError.bind(this);\n    this._channel.onmessage = this.onData.bind(this);\n    this._channel.onclose = this.onDisconnected.bind(\n      this,\n      new Error('peer data channel closed')\n    );\n\n    this._peer.setRemoteDescription({ type: 'offer', sdp });\n    this._peer\n      .createAnswer()\n      .then((d) => {\n        this._peer!.setLocalDescription(d);\n        this._ws!.send(\n          JSON.stringify({\n            event: EVENT.SIGNAL.ANSWER,\n            sdp: d.sdp,\n            displayname: this._displayname,\n          })\n        );\n      })\n      .catch((err) => this.emit('error', err));\n  }\n\n  private onMessage(e: MessageEvent) {\n    const { event, ...payload } = JSON.parse(e.data) as WebSocketMessages;\n\n    this.emit(\n      'debug',\n      `received websocket event ${event} ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n\n    if (event === EVENT.SIGNAL.PROVIDE) {\n      const { sdp, lite, ice, id } = payload as SignalProvidePayload;\n      this._id = id;\n      this.createPeer(sdp, lite, ice);\n      return;\n    }\n\n    // @ts-ignore\n    if (typeof this[event] === 'function') {\n      // @ts-ignore\n      this[event](payload);\n    } else {\n      this[EVENT.MESSAGE](event, payload);\n    }\n  }\n\n  private onData(e: MessageEvent) {\n    this[EVENT.DATA](e.data);\n  }\n\n  private onTrack(event: RTCTrackEvent) {\n    this.emit(\n      'debug',\n      `received ${event.track.kind} track from peer: ${event.track.id}`,\n      event\n    );\n    const stream = event.streams[0];\n    if (!stream) {\n      this.emit(\n        'warn',\n        `no stream provided for track ${event.track.id}(${event.track.label})`\n      );\n      return;\n    }\n    this[EVENT.TRACK](event);\n  }\n\n  private onError(event: Event) {\n    this.emit('error', (event as ErrorEvent).error);\n  }\n\n  private onConnected() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n\n    if (!this.connected) {\n      this.emit('warn', `onConnected called while being disconnected`);\n      return;\n    }\n\n    this.emit('debug', `connected`);\n    this[EVENT.CONNECTED]();\n  }\n\n  private onTimeout() {\n    this.emit('debug', `connection timeout`);\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n    this.onDisconnected(new Error('connection timeout'));\n  }\n\n  protected onDisconnected(reason?: Error) {\n    this.disconnect();\n    this.emit('debug', `disconnected:`, reason);\n    this[EVENT.DISCONNECTED](reason);\n  }\n\n  protected [EVENT.MESSAGE](event: string, payload: any) {\n    this.emit('warn', `unhandled websocket event '${event}':`, payload);\n  }\n\n  protected abstract [EVENT.CONNECTING](): void;\n  protected abstract [EVENT.CONNECTED](): void;\n  protected abstract [EVENT.DISCONNECTED](reason?: Error): void;\n  protected abstract [EVENT.TRACK](event: RTCTrackEvent): void;\n  protected abstract [EVENT.DATA](data: any): void;\n}\n"]},"metadata":{},"sourceType":"module"}